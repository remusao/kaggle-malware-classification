#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Usage:
    gen_test <archive>
    gen_test -h | --help

Options:
    -h, --help      Show help
"""

from __future__ import print_function
import docopt
import utils
import h5py


def load_test(path):
    """ Lazily load data from archive. Iterate on (label, file, content) """
    for uid, content in utils.file_iter(path):
        if uid.endswith('.bytes'):
            uid = uid[:-6]
            yield None, uid, content


def main():
    args = docopt.docopt(__doc__)

    test_set = load_test(args['<archive>'])
    extractor = utils.load_classifier('feature_extractor.pkl')

    print("# Extract features")
    features = extractor.fit_transform(test_set)

    # Create dataset
    with h5py.File('test_set.hdf5', 'w', driver='core') as f:
        f.create_dataset(
            'X',
            features.shape,
            dtype='f',
            compression="gzip",
            compression_opts=9,
            data=features)
        f.create_dataset(
            'IDS',
            features.shape[0],
            data=extractor.uids)


if __name__ == "__main__":
    main()
